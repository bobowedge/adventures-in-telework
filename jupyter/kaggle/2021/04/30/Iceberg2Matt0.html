<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Iceberg 2, Matt 0 | Adventures in Telework</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Iceberg 2, Matt 0" />
<meta name="author" content="Matt Bowen" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Reusing the random forest techniques for the Titanic on another dataset" />
<meta property="og:description" content="Reusing the random forest techniques for the Titanic on another dataset" />
<link rel="canonical" href="https://bobowedge.github.io/adventures-in-telework/jupyter/kaggle/2021/04/30/Iceberg2Matt0.html" />
<meta property="og:url" content="https://bobowedge.github.io/adventures-in-telework/jupyter/kaggle/2021/04/30/Iceberg2Matt0.html" />
<meta property="og:site_name" content="Adventures in Telework" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-30T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Reusing the random forest techniques for the Titanic on another dataset","url":"https://bobowedge.github.io/adventures-in-telework/jupyter/kaggle/2021/04/30/Iceberg2Matt0.html","@type":"BlogPosting","headline":"Iceberg 2, Matt 0","dateModified":"2021-04-30T00:00:00-05:00","datePublished":"2021-04-30T00:00:00-05:00","author":{"@type":"Person","name":"Matt Bowen"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bobowedge.github.io/adventures-in-telework/jupyter/kaggle/2021/04/30/Iceberg2Matt0.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/adventures-in-telework/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://bobowedge.github.io/adventures-in-telework/feed.xml" title="Adventures in Telework" /><link rel="shortcut icon" type="image/x-icon" href="/adventures-in-telework/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper">
<a class="site-title" rel="author" href="/adventures-in-telework/">Adventures in Telework</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/adventures-in-telework/about/">About Me</a><a class="page-link" href="/adventures-in-telework/search/">Search</a><a class="page-link" href="/adventures-in-telework/categories/">Tags</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Iceberg 2, Matt 0</h1>
<p class="page-description">Reusing the random forest techniques for the Titanic on another dataset</p>
<p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-04-30T00:00:00-05:00" itemprop="datePublished">
        Apr 30, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Matt Bowen</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      18 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i> 
      
        <a class="category-tags-link" href="/adventures-in-telework/categories/#jupyter">jupyter</a>
         
      
        <a class="category-tags-link" href="/adventures-in-telework/categories/#kaggle">kaggle</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/bobowedge/adventures-in-telework/tree/master/_notebooks/2021-04-30-Iceberg2Matt0.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/adventures-in-telework/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/bobowedge/adventures-in-telework/master?filepath=_notebooks%2F2021-04-30-Iceberg2Matt0.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/adventures-in-telework/assets/badges/binder.svg" alt="Open In Binder">
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/bobowedge/adventures-in-telework/blob/master/_notebooks/2021-04-30-Iceberg2Matt0.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/adventures-in-telework/assets/badges/colab.svg" alt="Open In Colab">
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-04-30-Iceberg2Matt0.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction"> </a>
</h2>
<p>In a <a href="https://bobowedge.github.io/adventures-in-telework/jupyter/2021/01/31/titanic-kaggle.html">previous post</a>, I wrote about using some random forest techniques to tackle the <a href="https://www.kaggle.com/c/titanic">Kaggle Titanic Competition</a>.  Last week, I found out that there's a <a href="https://www.kaggle.com/c/tabular-playground-series-apr-2021">monthly competition</a> that mimics the original Titanic competition, but uses synthetic data based on the original dataset instead. I thought it would be good to revisit the previous code I wrote and try it against this new dataset.</p>
<p>I'm not going to rehash everything I did before, but rather focus on the random forests, feature engineering, and neural networks to see what results I can get.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># imports, imports, imports</span>
<span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">zero_one_loss</span>

<span class="c1"># Pandas display options</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_rows</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">max_columns</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a>
</h2>
<h3 id="Data">Data<a class="anchor-link" href="#Data"> </a>
</h3>
<p>As before, the competition provides a training set (passenger data with a 'Survived' column) and a test set (passenger data without a 'Survived' column) and asks to be provided the prediced 'Survived' column for the test set.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dep_var</span> <span class="o">=</span> <span class="s1">'Survived'</span>
<span class="c1"># Training set</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"train.csv"</span><span class="p">)</span>
<span class="c1"># Test set</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">"test.csv"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a reminder, here what the training data looks like:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>PassengerId</th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>...</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>Oconnor, Frankie</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>209245</td>
      <td>27.14</td>
      <td>C12239</td>
      <td>S</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      <td>3</td>
      <td>Bryan, Drew</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>27323</td>
      <td>13.35</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>0</td>
      <td>3</td>
      <td>Owens, Kenneth</td>
      <td>male</td>
      <td>...</td>
      <td>2</td>
      <td>CA 457703</td>
      <td>71.29</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>0</td>
      <td>3</td>
      <td>Kramer, James</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>A. 10866</td>
      <td>13.04</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>1</td>
      <td>3</td>
      <td>Bond, Michael</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>427635</td>
      <td>7.76</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>99995</th>
      <td>99995</td>
      <td>1</td>
      <td>2</td>
      <td>Bell, Adele</td>
      <td>female</td>
      <td>...</td>
      <td>0</td>
      <td>PC 15008</td>
      <td>14.86</td>
      <td>D17243</td>
      <td>C</td>
    </tr>
    <tr>
      <th>99996</th>
      <td>99996</td>
      <td>0</td>
      <td>2</td>
      <td>Brown, Herman</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>13273</td>
      <td>11.15</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>99997</th>
      <td>99997</td>
      <td>0</td>
      <td>3</td>
      <td>Childress, Charles</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>9.95</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>99998</th>
      <td>99998</td>
      <td>0</td>
      <td>3</td>
      <td>Caughlin, Thomas</td>
      <td>male</td>
      <td>...</td>
      <td>1</td>
      <td>458654</td>
      <td>30.92</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>99999</th>
      <td>99999</td>
      <td>0</td>
      <td>3</td>
      <td>Enciso, Tyler</td>
      <td>male</td>
      <td>...</td>
      <td>0</td>
      <td>458074</td>
      <td>13.96</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
<p>100000 rows × 12 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>(If you refer back to the previous dataset, you can see that's there more than 100 times as much training data the in the original problem.)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, split the columns into either continuous and categorical types:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Split the columns into categorical and continuous</span>
<span class="n">cont_cols</span><span class="p">,</span> <span class="n">cat_cols</span> <span class="o">=</span> <span class="n">cont_cat_split</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="n">dep_var</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Continuous columns: </span><span class="si">{</span><span class="n">cont_cols</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Categorical columns: </span><span class="si">{</span><span class="n">cat_cols</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Continuous columns: ['PassengerId', 'Pclass', 'Age', 'SibSp', 'Parch', 'Fare']
Categorical columns: ['Name', 'Sex', 'Ticket', 'Cabin', 'Embarked']
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Reproducibility">Reproducibility<a class="anchor-link" href="#Reproducibility"> </a>
</h3>
<p>One of the things that I overlooked and later regretted when trying to document my results the last time around was never setting any of the random seed. That meant I could never reproduce the exact results in a future run. And, certainly, no one else who ever tried to run my code would get the same results. <sup id="fnref-1" class="footnote-ref"><a href="#fn-1">1</a></sup></p>
<p>I'm not the first <code>fastai</code> user to have this issue and <a href="https://forums.fast.ai/t/solved-reproducibility-where-is-the-randomness-coming-in/31628/27">some kind stranger</a> provided a function for setting some of the necessary seeds:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Set random_seed</span>
<span class="k">def</span> <span class="nf">random_seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">,</span> <span class="n">use_cuda</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span> <span class="c1"># cpu vars</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span> <span class="c1"># cpu vars</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span> <span class="c1"># Python</span>
    <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span> 
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed_value</span><span class="p">)</span> <span class="c1"># gpu vars</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1">#needed</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Unfortunately, this doesn't seem to set the seed for <code>RandomSplitter</code> or <code>RandomForestClassifier</code>, so I'll have to set those manually as well to get reproducible results.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Answer to Life, the Universe, and Everything</span>
<span class="n">ALUE</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">random_seed</span><span class="p">(</span><span class="n">ALUE</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Training-and-Validation-Data">Training and Validation Data<a class="anchor-link" href="#Training-and-Validation-Data"> </a>
</h3>
<p>Next, set up the training and validation data from the provided training set via <code>TabularPandas</code>:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Operations for columns</span>
<span class="n">column_ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">]</span>
<span class="c1"># Split the training data randomly</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">ALUE</span><span class="p">)(</span><span class="n">range_of</span><span class="p">(</span><span class="n">train_df</span><span class="p">))</span>
<span class="c1"># Setup TabularPandas</span>
<span class="n">tab_panda</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">column_ops</span> <span class="p">,</span><span class="n">cat_cols</span><span class="p">,</span> <span class="n">cont_cols</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="n">dep_var</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>
<span class="c1"># Aliases for training data</span>
<span class="n">trainxs</span><span class="p">,</span> <span class="n">trainy</span> <span class="o">=</span> <span class="n">tab_panda</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">tab_panda</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">y</span>
<span class="c1"># Aliases for validation data</span>
<span class="n">validxs</span><span class="p">,</span> <span class="n">validy</span> <span class="o">=</span> <span class="n">tab_panda</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">tab_panda</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">y</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training set size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">trainxs</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation set size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">validxs</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">trainxs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Training set size: 80000
Validation set size: 20000
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Name</th>
      <th>Sex</th>
      <th>Ticket</th>
      <th>Cabin</th>
      <th>Embarked</th>
      <th>...</th>
      <th>Pclass</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Fare</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1509</th>
      <td>2687</td>
      <td>1</td>
      <td>51792</td>
      <td>0</td>
      <td>3</td>
      <td>...</td>
      <td>3</td>
      <td>67.0</td>
      <td>1</td>
      <td>0</td>
      <td>29.680000</td>
    </tr>
    <tr>
      <th>83391</th>
      <td>73357</td>
      <td>2</td>
      <td>68733</td>
      <td>2240</td>
      <td>3</td>
      <td>...</td>
      <td>3</td>
      <td>30.0</td>
      <td>1</td>
      <td>2</td>
      <td>27.450001</td>
    </tr>
    <tr>
      <th>62311</th>
      <td>6430</td>
      <td>1</td>
      <td>4381</td>
      <td>0</td>
      <td>1</td>
      <td>...</td>
      <td>2</td>
      <td>45.0</td>
      <td>1</td>
      <td>1</td>
      <td>28.690001</td>
    </tr>
    <tr>
      <th>57794</th>
      <td>76737</td>
      <td>2</td>
      <td>32105</td>
      <td>0</td>
      <td>1</td>
      <td>...</td>
      <td>2</td>
      <td>32.0</td>
      <td>0</td>
      <td>0</td>
      <td>19.879999</td>
    </tr>
    <tr>
      <th>73100</th>
      <td>39937</td>
      <td>1</td>
      <td>56183</td>
      <td>0</td>
      <td>3</td>
      <td>...</td>
      <td>3</td>
      <td>10.0</td>
      <td>1</td>
      <td>0</td>
      <td>27.110001</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>29010</th>
      <td>87006</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>...</td>
      <td>3</td>
      <td>27.0</td>
      <td>0</td>
      <td>0</td>
      <td>9.910000</td>
    </tr>
    <tr>
      <th>77199</th>
      <td>34744</td>
      <td>2</td>
      <td>43849</td>
      <td>0</td>
      <td>3</td>
      <td>...</td>
      <td>3</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>6.630000</td>
    </tr>
    <tr>
      <th>44288</th>
      <td>42095</td>
      <td>2</td>
      <td>16114</td>
      <td>14524</td>
      <td>3</td>
      <td>...</td>
      <td>1</td>
      <td>2.0</td>
      <td>0</td>
      <td>0</td>
      <td>28.629999</td>
    </tr>
    <tr>
      <th>94835</th>
      <td>9105</td>
      <td>1</td>
      <td>17880</td>
      <td>9712</td>
      <td>1</td>
      <td>...</td>
      <td>1</td>
      <td>60.0</td>
      <td>1</td>
      <td>1</td>
      <td>290.769989</td>
    </tr>
    <tr>
      <th>53243</th>
      <td>60227</td>
      <td>1</td>
      <td>12517</td>
      <td>14929</td>
      <td>3</td>
      <td>...</td>
      <td>1</td>
      <td>45.0</td>
      <td>2</td>
      <td>2</td>
      <td>34.799999</td>
    </tr>
  </tbody>
</table>
<p>80000 rows × 13 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Also, convert the test data to <code>TabularPandas</code>:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_tab</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">test_df</span><span class="p">,</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">],</span> <span class="n">cat_cols</span><span class="p">,</span> <span class="n">cont_cols</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Random-Forest">Random Forest<a class="anchor-link" href="#Random-Forest"> </a>
</h2>
<p>This is enough to set up the function to create random forests. Since there's a lot more data, I choose to up the default for the minimum number of samples per leaf:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create Random Forest and fit it</span>
<span class="k">def</span> <span class="nf">create_rf</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="n">max_features</span><span class="p">,</span> 
                                  <span class="n">min_samples_leaf</span><span class="o">=</span><span class="n">min_samples_leaf</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">ALUE</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># 40-tree model with validation and out-of-bag (oob) error</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">create_rf</span><span class="p">(</span><span class="n">trainxs</span><span class="p">,</span> <span class="n">trainy</span><span class="p">)</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">zero_one_loss</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">validxs</span><span class="p">),</span> <span class="n">validy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model error: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model oob error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">oob_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Model error: 0.2251
Model oob error: 0.2216
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Last time, I somewhat arbitrarily picked a series of <code>n_estimator</code> values to try to deduce what the best number of trees was. This time<sup id="fnref-2" class="footnote-ref"><a href="#fn-2">2</a></sup>, I'm going to use the <code>GridSearch</code> available in sklearn.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Classifier settings to use for all forests</span>
<span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">ALUE</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Parameter grid to search</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"criterion"</span> <span class="p">:</span> <span class="p">[</span><span class="s2">"gini"</span><span class="p">,</span> <span class="s2">"entropy"</span><span class="p">],</span> 
              <span class="s2">"min_samples_leaf"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> 
              <span class="s2">"min_samples_split"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> 
              <span class="s2">"n_estimators"</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">700</span><span class="p">]}</span>

<span class="c1"># Set up the grid search parameters</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">rfc</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">'accuracy'</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Execute the grid search</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">trainxs</span><span class="p">,</span> <span class="n">trainy</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best model error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best model parameters: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best model error: 0.2167
Best model parameters: {'criterion': 'gini', 'min_samples_leaf': 10, 'min_samples_split': 2, 'n_estimators': 400}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The grid search took about 10 minutes to run on the GPU server I was using and produce the "best" model</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Select the best estimator from the grid search</span>
<span class="n">gsrf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">zero_one_loss</span><span class="p">(</span><span class="n">gsrf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">validxs</span><span class="p">),</span> <span class="n">validy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model error: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model oob error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gsrf</span><span class="o">.</span><span class="n">oob_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Model error: 0.2232
Model oob error: 0.2154
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I'll note here that the model errors are different in the last two steps because one is from the cross-validation of the training set and one is from the validation set.<sup id="fnref-3" class="footnote-ref"><a href="#fn-3">3</a></sup></p>
<p>Next, I used that model to predict the survivors from the test data and submit the predictions to kaggle:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Use the model to predict the survivors from the test set</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">gsrf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_tab</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tps-Apr2021_gridsearch.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_gridsearch.csv -m "RF Grid search"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>RF Grid Search score: 0.79187
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Just for fun, I also submitted the results of a model with 3000 trees to see whether that would be any better</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model3000</span> <span class="o">=</span> <span class="n">create_rf</span><span class="p">(</span><span class="n">trainxs</span><span class="p">,</span> <span class="n">trainy</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">model3000</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_tab</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tps-Apr2021_rf-3000.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_rf-3000.csv -m "RF with 3000 trees"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>RF 3000 score: 0.78166
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>NB: The grid search does slightly better than just taking a larger tree. (With the larger data set, small percentage differences are more significant.)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Feature-Engineering">Feature Engineering<a class="anchor-link" href="#Feature-Engineering"> </a>
</h2>
<p>The next step was to improve the random forest models above by extracting, modifying, or deleting some of the given columns to create new, hopefully more relevant ones by <a href="https://en.wikipedia.org/wiki/Feature_engineering">feature engineering</a>.</p>
<p>The collapse below has the features edits that I used last time, which I <del>stole</del> adapted from <a href="https://www.kaggle.com/zlatankr/titanic-random-forest-82-78">this post</a>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p></p>
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Same edit_features as last time</span>
<span class="k">def</span> <span class="nf">edit_features</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">mod_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># PassengerId - not meaningful for learning</span>
    <span class="k">del</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"PassengerId"</span><span class="p">]</span>
    
    <span class="c1"># Pclass - treat passenger class as category</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Pclass"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Pclass"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span>
    
    <span class="c1"># Name - Split into name length and title</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'NameLength'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Name"</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'NameTitle'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Name"</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'NameTitle'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"NameTitle"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Name"</span><span class="p">]</span>
    
    <span class="c1"># Age - fill Age with mean grouped by title and class</span>
    <span class="n">age_data</span> <span class="o">=</span> <span class="n">mod_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'NameTitle'</span><span class="p">,</span> <span class="s1">'Pclass'</span><span class="p">])[</span><span class="s1">'Age'</span><span class="p">]</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Age_na'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Age'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Age_na'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Age_na'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Age'</span><span class="p">]</span> <span class="o">=</span> <span class="n">age_data</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
    
    <span class="c1"># SibSp + Parch =&gt; Family size category</span>
    <span class="n">passengers</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"SibSp"</span><span class="p">]</span> <span class="o">+</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Parch"</span><span class="p">]</span> 
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'FamilySize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">passengers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'Solo'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">passengers</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'Nuclear'</span><span class="p">,</span> <span class="s1">'Big'</span><span class="p">))</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s2">"FamilySize"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"FamilySize"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'SibSp'</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Parch'</span><span class="p">]</span>
    
    <span class="c1"># Ticket - Split into two categories, </span>
    <span class="c1">#  one based on the first letter of the ticket and </span>
    <span class="c1">#  one based on the length</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s2">"TicketLetter"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Ticket"</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s2">"TicketLetter"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"TicketLetter"</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">highTicket</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'TicketLetter'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">'1'</span><span class="p">,</span> <span class="s1">'2'</span><span class="p">,</span> <span class="s1">'3'</span><span class="p">,</span> <span class="s1">'S'</span><span class="p">,</span> <span class="s1">'P'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'A'</span><span class="p">])</span>
    <span class="n">lowTicket</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'TicketLetter'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">'W'</span><span class="p">,</span> <span class="s1">'4'</span><span class="p">,</span> <span class="s1">'7'</span><span class="p">,</span> <span class="s1">'6'</span><span class="p">,</span> <span class="s1">'L'</span><span class="p">,</span> <span class="s1">'5'</span><span class="p">,</span> <span class="s1">'8'</span><span class="p">])</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'TicketLetter'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">highTicket</span><span class="p">,</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"TicketLetter"</span><span class="p">],</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lowTicket</span><span class="p">,</span> <span class="s2">"LowTicket"</span><span class="p">,</span> <span class="s2">"OtherTicket"</span><span class="p">))</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'TicketLength'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Ticket'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">del</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Ticket'</span><span class="p">]</span>
    
    <span class="c1"># Cabin - Split into the prefix and bin the number</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s2">"CabinPrefix"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Cabin'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s2">"CabinPrefix"</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"CabinPrefix"</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">"category"</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">mod_df</span><span class="p">[</span><span class="s2">"Cabin"</span><span class="p">]</span>
        
    <span class="c1"># Embarked - Fill missing data with most common value ('S')</span>
    <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Embarked'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod_df</span><span class="p">[</span><span class="s1">'Embarked'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">'S'</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mod_df</span>
</pre></div>

    </div>
</div>
</div>

    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Data">Data<a class="anchor-link" href="#Data"> </a>
</h3>
<p>The next step is to create the new dataframes for the validation and training set based on the feature edits.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># New data frame with modified features</span>
<span class="n">fe_train_df</span> <span class="o">=</span> <span class="n">edit_features</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>

<span class="c1"># Identify categorical and continuous columns and prep training data</span>
<span class="n">fe_cont</span><span class="p">,</span> <span class="n">fe_cat</span> <span class="o">=</span> <span class="n">cont_cat_split</span><span class="p">(</span><span class="n">fe_train_df</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="n">dep_var</span><span class="p">)</span>
<span class="n">fe_splits</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">ALUE</span><span class="p">)(</span><span class="n">range_of</span><span class="p">(</span><span class="n">fe_train_df</span><span class="p">))</span>
<span class="n">fe_train_panda</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">fe_train_df</span><span class="p">,</span> <span class="n">column_ops</span><span class="p">,</span> <span class="n">fe_cat</span><span class="p">,</span> <span class="n">fe_cont</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="n">dep_var</span><span class="p">,</span> <span class="n">splits</span><span class="o">=</span><span class="n">fe_splits</span><span class="p">)</span>

<span class="c1"># Alias training and validation data</span>
<span class="n">fetrainxs</span><span class="p">,</span> <span class="n">fetrainy</span> <span class="o">=</span> <span class="n">fe_train_panda</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">fe_train_panda</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">y</span>
<span class="n">fevalidxs</span><span class="p">,</span> <span class="n">fevalidy</span> <span class="o">=</span> <span class="n">fe_train_panda</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">xs</span><span class="p">,</span> <span class="n">fe_train_panda</span><span class="o">.</span><span class="n">valid</span><span class="o">.</span><span class="n">y</span>

<span class="n">fe_train_panda</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Pclass</th>
      <th>Sex</th>
      <th>Embarked</th>
      <th>NameTitle</th>
      <th>Age_na</th>
      <th>FamilySize</th>
      <th>TicketLetter</th>
      <th>CabinPrefix</th>
      <th>Fare_na</th>
      <th>Age</th>
      <th>Fare</th>
      <th>NameLength</th>
      <th>TicketLength</th>
      <th>Survived</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1509</th>
      <td>3</td>
      <td>female</td>
      <td>S</td>
      <td>Patricia</td>
      <td>False</td>
      <td>Nuclear</td>
      <td>OtherTicket</td>
      <td>n</td>
      <td>False</td>
      <td>67.0</td>
      <td>29.680000</td>
      <td>16</td>
      <td>4</td>
      <td>0</td>
    </tr>
    <tr>
      <th>83391</th>
      <td>3</td>
      <td>male</td>
      <td>S</td>
      <td>Robert</td>
      <td>False</td>
      <td>Nuclear</td>
      <td>S</td>
      <td>A</td>
      <td>False</td>
      <td>30.0</td>
      <td>27.450001</td>
      <td>14</td>
      <td>12</td>
      <td>0</td>
    </tr>
    <tr>
      <th>62311</th>
      <td>2</td>
      <td>female</td>
      <td>C</td>
      <td>Karen</td>
      <td>False</td>
      <td>Nuclear</td>
      <td>1</td>
      <td>n</td>
      <td>False</td>
      <td>45.0</td>
      <td>28.690001</td>
      <td>16</td>
      <td>6</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># New data frame with modified features</span>
<span class="n">fe_test_df</span> <span class="o">=</span> <span class="n">edit_features</span><span class="p">(</span><span class="n">test_df</span><span class="p">)</span>

<span class="c1"># Convert test data to TabularPandas</span>
<span class="n">fe_test_panda</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">fe_test_df</span><span class="p">,</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">],</span> <span class="n">fe_cat</span><span class="p">,</span> <span class="n">fe_cont</span><span class="p">)</span>

<span class="n">fe_test_panda</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Pclass</th>
      <th>Sex</th>
      <th>Embarked</th>
      <th>NameTitle</th>
      <th>Age_na</th>
      <th>FamilySize</th>
      <th>TicketLetter</th>
      <th>CabinPrefix</th>
      <th>Fare_na</th>
      <th>Age</th>
      <th>Fare</th>
      <th>NameLength</th>
      <th>TicketLength</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>male</td>
      <td>S</td>
      <td>Daniel</td>
      <td>False</td>
      <td>Solo</td>
      <td>2</td>
      <td>n</td>
      <td>False</td>
      <td>19.0</td>
      <td>63.009998</td>
      <td>16</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>female</td>
      <td>S</td>
      <td>Lorraine</td>
      <td>False</td>
      <td>Solo</td>
      <td>1</td>
      <td>n</td>
      <td>False</td>
      <td>53.0</td>
      <td>5.810000</td>
      <td>16</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>female</td>
      <td>C</td>
      <td>Heather</td>
      <td>False</td>
      <td>Solo</td>
      <td>2</td>
      <td>B</td>
      <td>False</td>
      <td>19.0</td>
      <td>38.910000</td>
      <td>15</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Grid-Search,-Part-Deux">Grid Search, Part Deux<a class="anchor-link" href="#Grid-Search,-Part-Deux"> </a>
</h3>
<p>The original post that had these feature edits also used a grid search to find better parameters for the random forest. I did not use that approach against the last data set, but I thought I would attempt it here.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rfc</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">,</span> <span class="n">oob_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">ALUE</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"criterion"</span> <span class="p">:</span> <span class="p">[</span><span class="s2">"gini"</span><span class="p">,</span> <span class="s2">"entropy"</span><span class="p">],</span> 
              <span class="s2">"min_samples_leaf"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> 
              <span class="s2">"min_samples_split"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> 
              <span class="s2">"n_estimators"</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">700</span><span class="p">]}</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">rfc</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">'accuracy'</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fetrainxs</span><span class="p">,</span> <span class="n">fetrainy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best model error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best model parameters: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Fitting 2 folds for each of 120 candidates, totalling 240 fits
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[Parallel(n_jobs=-1)]: Using backend LokyBackend with 8 concurrent workers.
[Parallel(n_jobs=-1)]: Done   9 tasks      | elapsed:   37.1s
[Parallel(n_jobs=-1)]: Done  82 tasks      | elapsed:  4.1min
[Parallel(n_jobs=-1)]: Done 205 tasks      | elapsed: 11.0min
[Parallel(n_jobs=-1)]: Done 240 out of 240 | elapsed: 12.7min finished
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best model error: 0.217
Best model parameters: {'criterion': 'gini', 'min_samples_leaf': 5, 'min_samples_split': 16, 'n_estimators': 700}
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This returned the same model as the original grid search. (If I tried to combined both searches into one, the parameter space was too large and crashed the GPU I was using.)</p>
<p>Check the error for the best model from the grid search:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Select the best estimator from the grid search</span>
<span class="n">gsrf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">zero_one_loss</span><span class="p">(</span><span class="n">gsrf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fevalidxs</span><span class="p">),</span> <span class="n">fevalidy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model error: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model oob error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gsrf</span><span class="o">.</span><span class="n">oob_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Model error: 0.2248
Model oob error: 0.2162
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Predict the survivors and submit:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Survival predictions</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">gsrf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fe_test_panda</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tps-Apr2021_fe-gridsearch.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_fe-gridsearch.csv -m "FE Grid search"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Grid search from FE score: 0.78973
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Because I ended up with the highest number of trees in the parameter set with this grid search, I also tried another grid search with some larger tree values:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"criterion"</span> <span class="p">:</span> <span class="p">[</span><span class="s2">"gini"</span><span class="p">],</span> 
              <span class="s2">"min_samples_leaf"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> 
              <span class="s2">"min_samples_split"</span> <span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> 
              <span class="s2">"n_estimators"</span><span class="p">:</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]}</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">rfc</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">'accuracy'</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">fetrainxs</span><span class="p">,</span> <span class="n">fetrainy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best model error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Best model parameters: </span><span class="si">{</span><span class="n">gs</span><span class="o">.</span><span class="n">best_params_</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Select the best estimator from the grid search</span>
<span class="n">gsrf</span> <span class="o">=</span> <span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">error</span> <span class="o">=</span> <span class="n">zero_one_loss</span><span class="p">(</span><span class="n">gsrf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fevalidxs</span><span class="p">),</span> <span class="n">fevalidy</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model error: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Model oob error: </span><span class="si">{</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gsrf</span><span class="o">.</span><span class="n">oob_score_</span><span class="si">:</span><span class="s2">.04</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># Survival predictions</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">gsrf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">fe_test_panda</span><span class="o">.</span><span class="n">xs</span><span class="p">)</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tps-Apr2021_fe-gridsearch-2.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Fitting 2 folds for each of 9 candidates, totalling 18 fits
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>[Parallel(n_jobs=-1)]: Using backend LokyBackend with 8 concurrent workers.
[Parallel(n_jobs=-1)]: Done   8 out of  18 | elapsed:  2.1min remaining:  2.7min
[Parallel(n_jobs=-1)]: Done  13 out of  18 | elapsed:  3.6min remaining:  1.4min
[Parallel(n_jobs=-1)]: Done  18 out of  18 | elapsed:  4.4min remaining:    0.0s
[Parallel(n_jobs=-1)]: Done  18 out of  18 | elapsed:  4.4min finished
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Best model error: 0.2164
Best model parameters: {'criterion': 'gini', 'min_samples_leaf': 5, 'min_samples_split': 50, 'n_estimators': 1000}
Model error: 0.2233
Model oob error: 0.2156
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_fe-gridsearch-2.csv -m "FE Grid search 2"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Grid search 2 from FE score: 0.79179
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The feature engineering does not seem to have improved the score over the grid search for the random forest. It's possible I just need to find the right parameters for the grid search for the feature engineering random forests, but hyperparameter optimization does not seem like much fun. <img class="emoji" title=":stuck_out_tongue:" alt=":stuck_out_tongue:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f61b.png" height="20" width="20"></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Neural-Network">Neural Network<a class="anchor-link" href="#Neural-Network"> </a>
</h2>
<p>Instead, let's see how a neural network does on this data set. As always, the first thing to do is set up the data.</p>
<p>I dropped the <code>PassengerId</code> column, since it's just an index, and set up the <code>TabularPandas</code> similar to before, the only major change is the addition of the <code>Normalize</code> operation:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Split the columns by cardinality of 500</span>
<span class="n">cont_cols</span><span class="p">,</span> <span class="n">cat_cols</span> <span class="o">=</span> <span class="n">cont_cat_split</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="n">dep_var</span><span class="p">)</span>
<span class="c1"># Drop the counter variable</span>
<span class="n">cont_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">'PassengerId'</span><span class="p">)</span>
<span class="c1"># Added the Normalize operation</span>
<span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
<span class="c1"># Make the TabularPandas object</span>
<span class="n">nn_train_tab</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span> <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_cols</span><span class="p">,</span> <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_cols</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="n">dep_var</span><span class="p">,</span> 
                             <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">y_block</span><span class="o">=</span><span class="n">CategoryBlock</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote>
<p><strong>Aside about API changes</strong>:Between the last post and today, there was a slight change in the <code>fastai</code> API for the tabular dataloaders. For some reason, supplying the PyTorch <code>l1_loss</code> function directly as the loss function now throws a warning about data shape mismatches between the input and target data probably causing inaccuracies. Instead, after some extensive googling and documentation reading, I'm just going to use the <code>accuracy</code> metric. Near as I can tell, this does the same thing.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, I set up the <code>DataLoader</code> and the learner itself and made a stab at finding an appropriate learning rate.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nn_dls</span> <span class="o">=</span> <span class="n">nn_train_tab</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">nn_dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Cabin</th>
      <th>Embarked</th>
      <th>Age_na</th>
      <th>Fare_na</th>
      <th>Age</th>
      <th>Fare</th>
      <th>Survived</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>Montoya, Jessica</td>
      <td>female</td>
      <td>1</td>
      <td>1</td>
      <td>451670</td>
      <td>#na#</td>
      <td>S</td>
      <td>False</td>
      <td>False</td>
      <td>5.000000</td>
      <td>32.650002</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3</td>
      <td>Saner, Trent</td>
      <td>male</td>
      <td>0</td>
      <td>0</td>
      <td>39137</td>
      <td>E13067</td>
      <td>C</td>
      <td>False</td>
      <td>False</td>
      <td>61.000001</td>
      <td>13.260001</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Gustovich, Jane</td>
      <td>female</td>
      <td>0</td>
      <td>0</td>
      <td>485531</td>
      <td>#na#</td>
      <td>C</td>
      <td>False</td>
      <td>False</td>
      <td>16.000001</td>
      <td>23.010001</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>Redden, Dorothy</td>
      <td>female</td>
      <td>0</td>
      <td>0</td>
      <td>440418</td>
      <td>#na#</td>
      <td>S</td>
      <td>False</td>
      <td>False</td>
      <td>31.000000</td>
      <td>26.440000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>Marks, Curtis</td>
      <td>male</td>
      <td>0</td>
      <td>0</td>
      <td>334870</td>
      <td>#na#</td>
      <td>S</td>
      <td>False</td>
      <td>False</td>
      <td>21.000000</td>
      <td>7.140000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3</td>
      <td>Munden, Robert</td>
      <td>male</td>
      <td>0</td>
      <td>0</td>
      <td>451650</td>
      <td>#na#</td>
      <td>S</td>
      <td>False</td>
      <td>False</td>
      <td>64.000000</td>
      <td>4.649998</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>Robinson, Maurice</td>
      <td>male</td>
      <td>0</td>
      <td>0</td>
      <td>SC/PARIS 451298</td>
      <td>#na#</td>
      <td>S</td>
      <td>False</td>
      <td>False</td>
      <td>31.000000</td>
      <td>11.890000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3</td>
      <td>Ellis, Herman</td>
      <td>male</td>
      <td>0</td>
      <td>0</td>
      <td>S.O.C. 16344</td>
      <td>#na#</td>
      <td>S</td>
      <td>False</td>
      <td>False</td>
      <td>58.999999</td>
      <td>81.129996</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>Escalante, Shawn</td>
      <td>male</td>
      <td>1</td>
      <td>0</td>
      <td>309115</td>
      <td>C2758</td>
      <td>C</td>
      <td>False</td>
      <td>False</td>
      <td>65.999999</td>
      <td>84.580001</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>Spieth, Lorna</td>
      <td>female</td>
      <td>0</td>
      <td>0</td>
      <td>PC 25390</td>
      <td>C10929</td>
      <td>C</td>
      <td>True</td>
      <td>False</td>
      <td>39.000000</td>
      <td>32.799999</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To everything, <a href="https://www.youtube.com/watch?v=W4ga_M5Zdn4">learn, learn, learn</a>:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">nn_dls</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.507917</td>
      <td>0.501651</td>
      <td>0.762350</td>
      <td>01:43</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If I try more than one epoch, the accuracy decreases along with the training loss, seemingly indicating some overfitting starts happening.</p>
<p>Next step is to make predictions and submit:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Make and submit predictions</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">test_df</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">survived</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"tps-Apr2021_nn.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_nn.csv -m "Neural network predictions"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>NN score: 0.73343
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As you can see, it's not quite as accurate as the random forests.</p>
<p>Another regret from my last foray was not running the neural network against the feature engineering data as well, so I'll do that now.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Split the columns by cardinality of 500</span>
<span class="n">cont_cols</span><span class="p">,</span> <span class="n">cat_cols</span> <span class="o">=</span> <span class="n">cont_cat_split</span><span class="p">(</span><span class="n">fe_train_df</span><span class="p">,</span> <span class="n">dep_var</span><span class="o">=</span><span class="n">dep_var</span><span class="p">)</span>
<span class="c1"># Added the Normalize operation</span>
<span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">]</span>
<span class="c1"># Make the TabularPandas object</span>
<span class="n">nn_train_tab</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">fe_train_df</span><span class="p">,</span> <span class="n">procs</span><span class="o">=</span><span class="n">procs</span><span class="p">,</span> <span class="n">cat_names</span><span class="o">=</span><span class="n">cat_cols</span><span class="p">,</span> <span class="n">cont_names</span><span class="o">=</span><span class="n">cont_cols</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="n">dep_var</span><span class="p">,</span> 
                             <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span> <span class="n">y_block</span><span class="o">=</span><span class="n">CategoryBlock</span><span class="p">)</span>

<span class="n">nn_dls</span> <span class="o">=</span> <span class="n">nn_train_tab</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
<span class="n">nn_dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">nn_dls</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.489520</td>
      <td>0.489564</td>
      <td>0.770850</td>
      <td>00:07</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Make and submit predictions</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">learn</span><span class="o">.</span><span class="n">get_preds</span><span class="p">(</span><span class="n">dl</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">test_dl</span><span class="p">(</span><span class="n">fe_test_df</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">survived</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"tps-Apr2021_nn-fe.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_nn-fe.csv -m "Neural network predictions on feature engineering"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>NN with FE score: 0.77028
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This score is significantly better than the non-engineering features neural network; I don't know why that is. This model also trains faster than anything else above.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Ensemble">Ensemble<a class="anchor-link" href="#Ensemble"> </a>
</h2>
<p>Now, I've got a handful of models that take slightly different approaches.  I can combine them all into a single model using a majority vote to decide who survived.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Gather the models</span>
<span class="n">model_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"tps-Apr2021_gridsearch.csv"</span><span class="p">,</span> <span class="c1"># Random forest grid search result</span>
               <span class="s2">"tps-Apr2021_fe-gridsearch-2.csv"</span><span class="p">,</span> <span class="c1"># Random forest with feature engineering grid search result</span>
               <span class="s2">"tps-Apr2021_nn-fe.csv"</span> <span class="c1"># Neural network with feature engineering</span>
              <span class="p">]</span>

<span class="c1"># Combined the models into a table</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_files</span><span class="p">):</span>
    <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">mfile</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">'Survived'</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Majority vote</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">downcast</span><span class="o">=</span><span class="s1">'integer'</span><span class="p">)</span>

<span class="c1"># Save to csv and submit</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"tps-Apr2021_ensemble1.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_ensemble1.csv -m "Ensemble1"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Ensemble1 score: 0.79191
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this case, the ensemble scored better than any of the individual models (albeit by a net of 1 prediction against the best model so far).</p>
<p>I had one more submission remaining before the competition closed, so I tried one additional ensemble as well</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"tps-Apr2021_gridsearch.csv"</span><span class="p">,</span> <span class="c1"># 400 tree Random forest from grid search</span>
               <span class="s2">"tps-Apr2021_fe-gridsearch-2.csv"</span><span class="p">,</span> <span class="c1"># 1000 tree Random forest with feature engineering from grid search</span>
               <span class="s2">"tps-Apr2021_nn-fe.csv"</span><span class="p">,</span> <span class="c1"># Neural network with feature engineering</span>
               <span class="s2">"tps-Apr2021_rf-3000.csv"</span><span class="p">,</span> <span class="c1"># 3000 tree Random Forest</span>
               <span class="s2">"tps-Apr2021_fe-gridsearch.csv"</span> <span class="c1"># 700 tree Random forest with feature engineering from grid search</span>
              <span class="p">]</span>

<span class="c1"># Combined the models into a table</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_files</span><span class="p">):</span>
    <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">mfile</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">'Survived'</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Majority vote</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">downcast</span><span class="o">=</span><span class="s1">'integer'</span><span class="p">)</span>

<span class="c1"># Save to csv and submit</span>
<span class="n">submission</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'PassengerId'</span><span class="p">:</span> <span class="n">test_df</span><span class="p">[</span><span class="s1">'PassengerId'</span><span class="p">],</span> <span class="s1">'Survived'</span> <span class="p">:</span> <span class="n">survived</span><span class="p">})</span>
<span class="n">submission</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">"tps-Apr2021_ensemble2.csv"</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>!kaggle competitions submit -c tabular-playground-series-apr-2021 -f tps-Apr2021_ensemble2.csv -m "Ensemble2"</code></p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Ensemble2 score: 0.79115
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Not quite as good, but definitely in the ballpark.</p>
<h2 id="Results">Results<a class="anchor-link" href="#Results"> </a>
</h2>
<p>The competition allowed two submissions to be run against the final data to determine the final score. For my entry, I chose the first ensemble and 400-tree random forest that came from the initial grid search, since they gave my best scores on the pre-final data. Prior to the final, I was ranked 734th out of 1219.</p>
<p>My final ranking was 634 out of 1244. My final score was 0.79104 and was from the submission from the initial random forest grid search. The top score on the leaderboard was 0.81328.  Maybe I shouldn't yet quit my job to become a full-time data scientist. <img class="emoji" title=":open_mouth:" alt=":open_mouth:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f62e.png" height="20" width="20"></p>
<p>MEME TIME!!</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<div class="footnotes"><p id="fn-1">1. Not that I think anyone is actually trying to copy my code and run it. This is purely a hypothetical.<a href="#fnref-1" class="footnote footnotes">↩</a></p></div>
<p></p>
<div class="footnotes"><p id="fn-2">2. At the suggestion of Psi. Thanks, Psi!<a href="#fnref-2" class="footnote footnotes">↩</a></p></div>
<p></p>
<div class="footnotes"><p id="fn-3">3. If I were doing this for a living or something serious, I probably would have fed the entire training set into <code>GridSearchCV</code>, rather than just the training portion of split, since <code>GridSearchCV</code> does cross-validation.<a href="#fnref-3" class="footnote footnotes">↩</a></p></div>

</div>
</div>
</div>
</div>



  </div>
<!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js" repo="bobowedge/adventures-in-telework" issue-term="title" label="blogpost-comment" theme="github-light" crossorigin="anonymous" async>
</script><a class="u-url" href="/adventures-in-telework/jupyter/kaggle/2021/04/30/Iceberg2Matt0.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/adventures-in-telework/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/adventures-in-telework/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/adventures-in-telework/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>What happens when I work when I'm not at work</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list"><li><a rel="me" href="https://github.com/bobowedge" title="bobowedge"><svg class="svg-icon grey"><use xlink:href="/adventures-in-telework/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
